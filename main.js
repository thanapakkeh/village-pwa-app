import { app } from "./firebase-config.js";
import { getFirestore, doc, getDoc } from "firebase/firestore";

const db = getFirestore(app);

async function searchByHouseNumber(houseNumber) {
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  try {
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore
    const docRef = doc(db, "houses", houseNumber);
    const docSnap = await getDoc(docRef);

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å JSON
    const response = await fetch("data.json");
    const jsonData = await response.json();
    const jsonMatch = jsonData.find(d => d["‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà"] === houseNumber);

    // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡πÅ‡∏•‡∏∞ JSON
    if (docSnap.exists() && jsonMatch) {
      const firestoreData = docSnap.data();

      resultDiv.innerHTML = `
        <div style="background:white;border-radius:8px;padding:15px;box-shadow:0 0 10px rgba(0,0,0,0.05);text-align:left;">
          <p>üè† <strong>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> ${houseNumber}</p>
          <p>üìÖ <strong>‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (JSON):</strong> ${jsonMatch["‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞"]}</p>
          <p>üí∞ <strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (JSON):</strong> ${jsonMatch["‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞"]} ‡∏ö‡∏≤‡∏ó</p>
          <p>üóÉÔ∏è <strong>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (Firestore):</strong> ${firestoreData.outstanding}</p>
          <p>üìÜ <strong>‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (Firestore):</strong> ${firestoreData.period}</p>
          ${jsonMatch["‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ"] ? `<a href="${jsonMatch["‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ"]}" target="_blank" style="display:inline-block;margin-top:10px;padding:10px 15px;background:#10b981;color:white;border-radius:5px;text-decoration:none;">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</a>` : ""}
        </div>
      `;
    } else if (jsonMatch) {
      // ‡πÄ‡∏à‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô JSON
      resultDiv.innerHTML = `
        <div style="background:white;border-radius:8px;padding:15px;box-shadow:0 0 10px rgba(0,0,0,0.05);text-align:left;">
          <p>üè† <strong>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> ${houseNumber}</p>
          <p>üìÖ <strong>‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</strong> ${jsonMatch["‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞"]}</p>
          <p>üí∞ <strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</strong> ${jsonMatch["‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞"]} ‡∏ö‡∏≤‡∏ó</p>
          ${jsonMatch["‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ"] ? `<a href="${jsonMatch["‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ"]}" target="_blank" style="display:inline-block;margin-top:10px;padding:10px 15px;background:#10b981;color:white;border-radius:5px;text-decoration:none;">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</a>` : ""}
        </div>
      `;
    } else if (docSnap.exists()) {
      // ‡πÄ‡∏à‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô Firestore
      const firestoreData = docSnap.data();

      resultDiv.innerHTML = `
        <div style="background:white;border-radius:8px;padding:15px;box-shadow:0 0 10px rgba(0,0,0,0.05);text-align:left;">
          <p>üè† <strong>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> ${houseNumber}</p>
          <p>üóÉÔ∏è <strong>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</strong> ${firestoreData.outstanding}</p>
          <p>üìÜ <strong>‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</strong> ${firestoreData.period}</p>
        </div>
      `;
    } else {
      // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢
      resultDiv.innerHTML = `<p style="color:red;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ</p>`;
    }
  } catch (error) {
    console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
    resultDiv.innerHTML = `<p style="color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
  }
}

window.searchByHouseNumber = searchByHouseNumber;
