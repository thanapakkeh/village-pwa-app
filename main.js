window.searchByHouseNumber = async function (houseNumber) {
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  try {
    // ‡∏≠‡πà‡∏≤‡∏ô URL API ‡∏à‡∏≤‡∏Å data.json
    const sourceRes = await fetch("data.json");
    const sourceData = await sourceRes.json();
    const apiUrl = sourceData.source;

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API Google Sheet
    const res = await fetch(apiUrl);
    const data = await res.json();

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà
    const match = data.find(d => d["‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà"] === houseNumber);

    if (match) {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏ô
      resultDiv.innerHTML = `
        <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.06);text-align:left;">
          <p style="font-size: 1.2rem;"><strong>üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</strong> ${match["‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞"]}</p>

          <div style="margin: 20px 0 10px;">
            <p style="font-size: 1.1rem; font-weight: bold; color:#111; margin-bottom: 5px;">üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
            <p style="font-size: 1.8rem; font-weight: bold; color:#dc2626; margin: 0;">${match["‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞"]} ‡∏ö‡∏≤‡∏ó</p>
          </div>

          <p style="font-size:0.95rem;color:#666;margin-top:10px;">üìÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${match["‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"]}</p>

          <div style="margin-top:25px; display:flex; flex-direction:column; gap:12px;">
            <a href="payment.html"
              style="background:#10b981;color:white;padding:12px;border-radius:8px;
                    text-align:center;text-decoration:none;font-weight:bold;">
              üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á
            </a>
            <a href="contact.html"
              style="background:#3b82f6;color:white;padding:12px;border-radius:8px;
                    text-align:center;text-decoration:none;font-weight:bold;">
              üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
            </a>
          </div>
        </div>
      `;
    } else {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏ô
      resultDiv.innerHTML = `
        <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.06);text-align:left;font-size:1rem;line-height:1.6;">
          <p>‚úÖ <strong>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</strong></p>
          <p>üí∞ <strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</strong> 0 ‡∏ö‡∏≤‡∏ó</p>
          <p style="font-size:0.9rem;color:#666;margin-top:8px;">üìÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: 28 ‡∏Å.‡∏û. 68</p>

          <div style="margin-top:25px;">
            <a href="contact.html"
              style="background:#3b82f6;color:white;padding:12px;border-radius:8px;
                    text-align:center;text-decoration:none;font-weight:bold;display:block;">
              üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
            </a>
          </div>
        </div>
      `;
    }

  } catch (error) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
    resultDiv.innerHTML = `<p style="color:red;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
  }
};

window.showUserData = function () {
  const user = JSON.parse(localStorage.getItem("loggedInUser"));
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  const houseId = user.house;
  document.getElementById("house-id").innerText = `üè† ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${houseId}`;
  searchByHouseNumber(houseId);
};

window.logout = function () {
  localStorage.removeItem("loggedInUser");
  window.location.href = "login.html";
};
